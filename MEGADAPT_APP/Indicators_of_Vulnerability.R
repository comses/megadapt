#Indicators of Vulnerability
require(leaflet)
Initial_outcome=subset(TS_res,year_sim==2020)
final_outcome=subset(TS_res,year_sim==(2018+time_simulation)) #indicate final year for outcome  

Final_Outcome=studyArea_CVG



Final_Outcome@data=final_outcome

#####save Final_Outcome result as shape file######
#writeSpatialShape(x = Final_Outcome,fn = paste(path_to_output,'Output_MEGADAPT_Oct2018',sep=""))

#Final_Outcome$encharca<-round(studyArea_CVG@data$f_en)
#show results as map
xl=c(-98.9, -99.3)
yl=c(19, 19.6)

####################Labels for highlights



labels_ponding <- sprintf(
  "<strong>%s</strong><br/>%g ID / %g events",
  Final_Outcome$AGEB_ID,Final_Outcome$municipio,Final_Outcome$encharca
) %>% lapply(htmltools::HTML)

labels_ponding_data <- sprintf(
  "<strong>%s</strong><br/>%g ID / %g events",
  Final_Outcome$AGEB_ID,Final_Outcome$municipio,Final_Outcome$f_en
) %>% lapply(htmltools::HTML)



labels_scarcity <- sprintf(
  "<strong>%s</strong><br/>%g ID / %g average days/week",
  Final_Outcome$AGEB_ID,Final_Outcome$municipio,round(Final_Outcome$NOWater_week_pois)
) %>% lapply(htmltools::HTML)

labels_scarcity_data <- sprintf(
  "<strong>%s</strong><br/>%g ID / %g average days/week",
  Final_Outcome$AGEB_ID,Final_Outcome$municipio,Final_Outcome$lambdas
) %>% lapply(htmltools::HTML)


labels_gov_interventions_D <- sprintf(
  "<strong>%s</strong><br/>%g ID / %g interventions",
  Final_Outcome$AGEB_ID,Final_Outcome$municipio,round(Final_Outcome$Interventions_D)
) %>% lapply(htmltools::HTML)

labels_gov_interventions_Ab <- sprintf(
  "<strong>%s</strong><br/>%g ID / %g interventions",
  Final_Outcome$AGEB_ID,Final_Outcome$municipio,round(Final_Outcome$Interventions_Ab)
) %>% lapply(htmltools::HTML)

labels_protest <- sprintf(
  "<strong>%s</strong><br/>%g ID / %g Protests",
  Final_Outcome$AGEB_ID,Final_Outcome$municipio,round(Final_Outcome$social_pressure)
) %>% lapply(htmltools::HTML)

labels_adaptation_D <- sprintf(
  "<strong>%s</strong><br/>%g ID / %g interventions",
  Final_Outcome$AGEB_ID,Final_Outcome$municipio,Final_Outcome$sensitivity_D
) %>% lapply(htmltools::HTML)

labels_adaptation_W <- sprintf(
  "<strong>%s</strong><br/>%g ID / %g interventions",
  Final_Outcome$AGEB_ID,Final_Outcome$municipio,Final_Outcome$sensitivity_Ab
) %>% lapply(htmltools::HTML)

labels_Infra_D <- sprintf(
  "<strong>%s</strong><br/>%g ID / %g Years",
  Final_Outcome$AGEB_ID,Final_Outcome$municipio,Final_Outcome$antiguedad_D
) %>% lapply(htmltools::HTML)

labels_Infra_W <- sprintf(
  "<strong>%s</strong><br/>%g ID / %g Years",
    Final_Outcome$AGEB_ID,Final_Outcome$municipio,Final_Outcome$antiguedad_Ab
) %>% lapply(htmltools::HTML)


########colors pals########################################
##
pal <- colorNumeric(
  palette = "YlOrRd",
  domain = Final_Outcome$vulnerability_D
)

pal_infra_Ab <- colorNumeric(
  palette = "YlOrRd",
  domain = Final_Outcome$antiguedad_Ab
)

pal_infra_D <- colorNumeric(
  palette = "YlOrRd",
  domain = Final_Outcome$antiguedad_D
)

pal_ponding <- colorNumeric(
  palette = "Blues",
  domain = Final_Outcome$encharca
)

pal_ponding_data <- colorNumeric(
  palette = "Blues",
  domain = Final_Outcome$f_en
)


pal_scarcity <- colorNumeric(
  palette = "Reds",
  domain = Final_Outcome$NOWater_week_pois
)
pal_scarcity_data <- colorNumeric(
  palette = "Reds",
  domain = Final_Outcome$lambdas
)


pal_adaptation_AB <- colorNumeric(
  palette = "Reds",
  domain = Final_Outcome$sensitivity_Ab,
  reverse = F
)

pal_adaptation_D <- colorNumeric(
  palette = "Blues",
  domain = Final_Outcome$sensitivity_D,
  reverse = F
  
)
#pal_adaptation_D<-colorBin(
#  palette = "Blues",
#  domain = Final_Outcome$sensitivity_D)

#qpal <- colorQuantile("Blues", Final_Outcome$encharca)

pal_interventions_D<-colorBin(
  palette = "Blues",
  domain = Final_Outcome$Interventions_D)

pal_interventions_Ab<-colorBin(
  palette = "Reds",
  domain = Final_Outcome$Interventions_Ab)

pal_protests<-colorNumeric(
  palette = "Reds",
  domain = Final_Outcome$social_pressure)

############################################################
m <- leaflet(data=Final_Outcome) %>%
  addTiles("Indicators of Vulnerability") %>%
    addTiles() %>%  # Add default OpenStreetMap map tiles
  addMarkers(lng=-99.1398, lat=19.4249,popup="Mexico City") %>%
  addPolygons(fillColor = "transparent", stroke = FALSE,group = "Mapa Base") %>%
  
  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.5,
              fillColor = ~pal_infra_D(antiguedad_D),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE),
              group = "Infrastructure_D",
              label=labels_Infra_D)%>%

  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.5,
              fillColor = ~pal_infra_Ab(antiguedad_Ab),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE),
              group = "Infrastructure_W",
              label=labels_Infra_W)%>%
  
    
  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
             opacity = 1.0, fillOpacity = 0.5,
              fillColor = ~colorQuantile("YlOrRd", vulnerability_D)(vulnerability_D),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE),group = "Vulnerability_D")%>%
  
  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.5,
              fillColor = ~pal_ponding(encharca),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE
                                                  ),
              group = "Ponding",
              label = labels_ponding)%>%
  
  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.5,
              fillColor = ~pal_ponding_data(f_en),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE
              ),
              group = "Ponding_data",
              label = labels_ponding_data)%>%
  
  
  
  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.5,
              fillColor = ~pal_scarcity(NOWater_week_pois),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE),
              group = "Scarcity",
              label=labels_scarcity)%>%
  
  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.5,
              fillColor = ~pal_scarcity_data(NOWater_week_pois),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE),
              group = "Scarcity_data",
              label=labels_scarcity_data)%>%
  
  
  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.5,
              fillColor = ~pal_adaptation_AB(sensitivity_Ab),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE),
              group = "Adaptation_W",
              label=labels_adaptation_W)%>%
  
  
  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.5,
              fillColor = ~pal_adaptation_D(sensitivity_D),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE),
              group = "Adaptation_D",
              label=labels_adaptation_D)%>%
  
  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.5,
              fillColor = ~pal_interventions_D(Interventions_D),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE),
              group = "Interventions_D",
              label=labels_gov_interventions_D)%>%
  
  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.5,
              fillColor = ~pal_interventions_Ab(Interventions_Ab),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE),
              group = "Interventions_W",
              label=labels_gov_interventions_Ab)%>%
  
  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.5,
              fillColor = ~pal_protests(social_pressure),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE),
              group = "Social_Pressure",
              label=labels_protest)%>%
    
  setView(lng=mean(xl), lat=mean(yl), zoom = 10) %>%
  
#############legends######################################
  addLegend("bottomright", pal = pal, values = ~vulnerability_D,
            title = "Vulnerability Drainage",
            labFormat = labelFormat(prefix = ""),
            opacity = 1,group = "Vulnerability_D"
  )%>%
  addLegend("bottomright", pal = pal_infra_Ab, values = ~antiguedad_Ab,
            title = "Infrastructure",
            labFormat = labelFormat(prefix = ""),
            opacity = 1,group = "Infrastructure_W"
  )%>%
  addLegend("bottomright", pal = pal_infra_D, values = ~antiguedad_D,
            title = "Infrastructure",
            labFormat = labelFormat(prefix = ""),
            opacity = 1,group = "Infrastructure_D"
  )%>%
  
  addLegend("bottomright", pal = pal_ponding, values = ~encharca,
            title = "Ponding",
            labFormat = labelFormat(prefix = ""),
            opacity = 1,group = "Ponding"
  )%>%
  addLegend("bottomright", pal = pal_ponding_data, values = ~f_en,
            title = "Ponding_data",
            labFormat = labelFormat(prefix = ""),
            opacity = 1,group = "Ponding_data"
  )%>%
  addLegend("bottomright", pal = pal_scarcity, values = ~NOWater_week_pois,
            title = " Water Scarcity [days/weeks]",
            labFormat = labelFormat(prefix = ""),
            opacity = 1,group = "Scarcity"
  )%>%
  addLegend("bottomright", pal = pal_scarcity_data, values = ~lambdas,
            title = " Water Scarcity [days/weeks]",
            labFormat = labelFormat(prefix = ""),
            opacity = 1,group = "Scarcity_data"
  )%>%
  addLegend("bottomright", pal = pal_adaptation_AB, values = ~sensitivity_Ab,
            title = "# actions residents W",
            labFormat = labelFormat(prefix = ""),
            opacity = 1,group = "Adaptation_W"
  )%>%
  addLegend("bottomright", pal = pal_adaptation_D, values = ~sensitivity_D,
            title = "# actions residents D",
            labFormat = labelFormat(prefix = ""),
            opacity = 1,group = "Adaptation_D"
  )%>%
  addLegend("bottomright", pal = pal_interventions_D, values = ~Interventions_D,
            title = "# actions residents D",
            labFormat = labelFormat(prefix = ""),
            opacity = 1,group = "Interventions_D"
  )%>%
  addLegend("bottomright", pal = pal_interventions_Ab, values = ~Interventions_Ab,
            title = "# actions residents W",
            labFormat = labelFormat(prefix = ""),
            opacity = 1,group = "Interventions_W"
  )%>%
  
  addLegend("bottomright", pal = pal_protests, values = ~social_pressure,
            title = "# actions residents W",
            labFormat = labelFormat(prefix = ""),
            opacity = 1,group = "Social_Pressure"
  )%>%
#####control############
  addLayersControl(
  baseGroups = c("Mapa Base"),
  overlayGroups = c("Vulnerability_D", "Infrastructure_D","Infrastructure_W","Ponding","Ponding_data","Scarcity","Scarcity_data","Adaptation_W","Adaptation_D","Interventions_D","Interventions_W","Social_Pressure"),
  options = layersControlOptions(collapsed = FALSE)
)%>%
hideGroup(c("Vulnerability_D","Infrastructure_D","Infrastructure_W","Ponding","Ponding_data","Scarcity","Scarcity_data","Adaptation_W","Adaptation_D","Interventions_D","Interventions_W","Social_Pressure"))
print(m)
