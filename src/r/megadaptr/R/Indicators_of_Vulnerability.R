#Indicators of Vulnerability
map_results=function(megadapt_model, megadapt_output){

  Initial_outcome=subset(megadapt_output,year_sim==2018)
final_outcome=subset(megadapt_output,year_sim==(2018+megadapt_model$params$n_steps)) #indicate final year for outcome

Final_Outcome=megadapt_model$study_area



Final_Outcome@data=final_outcome

#####save Final_Outcome result as shape file######
#writeSpatialShape(x = Final_Outcome,fn = paste(path_to_output,'Output_MEGADAPT_Oct2018',sep=""))

#Final_Outcome$days_with_ponding<-round(studyArea_CVG@data$f_en)
#show results as map
xl=c(-98.9, -99.3)
yl=c(19, 19.6)

####################Labels for highlights



labels_ponding <- sprintf(
  "<strong>%s</strong><br/>%s ID / %g events",
  Final_Outcome$ageb_id,Final_Outcome$cvgeo,Final_Outcome$days_with_ponding
) %>% lapply(htmltools::HTML)

labels_flooding <- sprintf(
  "<strong>%s</strong><br/>%s ID / %g events",
  Final_Outcome$ageb_id,Final_Outcome$cvgeo,Final_Outcome$days_with_flooding
) %>% lapply(htmltools::HTML)



labels_scarcity <- sprintf(
  "<strong>%s</strong><br/>%s ID / %g average days/week",
  Final_Outcome$ageb_id,Final_Outcome$cvgeo,Final_Outcome$potable_water_sensitivity_index
) %>% lapply(htmltools::HTML)

labels_scarcity_data <- sprintf(
  "<strong>%s</strong><br/>%s ID / %g average days/week",
  Final_Outcome$ageb_id,Final_Outcome$cvgeo,Final_Outcome$days_no_potable_water
) %>% lapply(htmltools::HTML)


labels_gov_interventions_D <- sprintf(
  "<strong>%s</strong><br/>%s ID / %g interventions",
  Final_Outcome$ageb_id,Final_Outcome$cvgeo,Final_Outcome$non_potable_water_system_intervention_count
) %>% lapply(htmltools::HTML)

labels_gov_potable_water_system_intervention_count <- sprintf(
  "<strong>%s</strong><br/>%s ID / %g interventions",
  Final_Outcome$ageb_id,Final_Outcome$cvgeo,Final_Outcome$potable_water_system_intervention_count
) %>% lapply(htmltools::HTML)

labels_protest <- sprintf(
  "<strong>%s</strong><br/>%s ID / %g Protests",
  Final_Outcome$ageb_id,Final_Outcome$cvgeo,Final_Outcome$water_scarcity_index
) %>% lapply(htmltools::HTML)

labels_adaptation_D <- sprintf(
  "<strong>%s</strong><br/>%s ID / %g interventions",
  Final_Outcome$ageb_id,Final_Outcome$cvgeo,Final_Outcome$non_potable_water_sensitivity_index
) %>% lapply(htmltools::HTML)

labels_adaptation_W <- sprintf(
  "<strong>%s</strong><br/>%s ID / %g interventions",
  Final_Outcome$ageb_id,Final_Outcome$cvgeo,Final_Outcome$potable_water_sensitivity_index
) %>% lapply(htmltools::HTML)

labels_Infra_D <- sprintf(
  "<strong>%s</strong><br/>%s ID / %s Years",
  Final_Outcome$ageb_id,Final_Outcome$cvgeo,Final_Outcome$non_potable_water_infrastructure_age
) %>% lapply(htmltools::HTML)

labels_Infra_W <- sprintf(
  "<strong>%s</strong><br/>%s ID / %s Years",
    Final_Outcome$ageb_id,Final_Outcome$cvgeo,Final_Outcome$potable_water_infrastructure_age
) %>% lapply(htmltools::HTML)


########colors pals########################################
##
pal <- colorNumeric(
  palette = "YlOrRd",
  domain = Final_Outcome$non_potable_water_vulnerability_index
)

pal_infra_Ab <- colorNumeric(
  palette = "YlOrRd",
  domain = Final_Outcome$potable_water_infrastructure_age
)

pal_infra_D <- colorNumeric(
  palette = "YlOrRd",
  domain = Final_Outcome$non_potable_water_infrastructure_age
)

pal_ponding <- colorNumeric(
  palette = "Blues",
  domain = Final_Outcome$days_with_ponding
)

pal_flooding <- colorNumeric(
  palette = "Blues",
  domain = Final_Outcome$days_with_flooding
)


pal_scarcity <- colorNumeric(
  palette = "Reds",
  domain = Final_Outcome$water_scarcity_index
)
pal_scarcity_data <- colorNumeric(
  palette = "Reds",
  domain = Final_Outcome$days_no_potable_water
)


pal_adaptation_AB <- colorNumeric(
  palette = "Reds",
  domain = Final_Outcome$potable_water_sensitivity_index,
  reverse = F
)

pal_adaptation_D <- colorNumeric(
  palette = "Blues",
  domain = Final_Outcome$non_potable_water_sensitivity_index,
  reverse = F

)
#pal_adaptation_D<-colorBin(
#  palette = "Blues",
#  domain = Final_Outcome$non_potable_water_sensitivity_index)

#qpal <- colorQuantile("Blues", Final_Outcome$days_with_ponding)

pal_interventions_D<-colorBin(
  palette = "Blues",
  domain = Final_Outcome$non_potable_water_system_intervention_count)

pal_potable_water_system_intervention_count<-colorBin(
  palette = "Reds",
  domain = Final_Outcome$potable_water_system_intervention_count)

pal_protests<-colorNumeric(
  palette = "Reds",
  domain = Final_Outcome$water_scarcity_index)

############################################################
m <- leaflet(data=Final_Outcome) %>%
  addTiles("Indicators of Vulnerability") %>%
    addTiles() %>%  # Add default OpenStreetMap map tiles
  addMarkers(lng=-99.1398, lat=19.4249,popup="Mexico City") %>%
  addPolygons(fillColor = "transparent", stroke = FALSE,group = "Mapa Base") %>%

  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.5,
              fillColor = ~pal_infra_D(non_potable_water_infrastructure_age),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE),
              group = "Infrastructure_D",
              label=labels_Infra_D)%>%

  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
             opacity = 1.0, fillOpacity = 0.5,
             fillColor = ~pal_infra_Ab(potable_water_infrastructure_age),
            highlightOptions = highlightOptions(color = "white", weight = 2,
                                                bringToFront = TRUE),
             group = "Infrastructure_W",
            label=labels_Infra_W)%>%


  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
             opacity = 1.0, fillOpacity = 0.5,
              fillColor = ~colorQuantile("YlOrRd", non_potable_water_vulnerability_index)(non_potable_water_vulnerability_index),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE),group = "Vulnerability_D")%>%

  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.5,
              fillColor = ~pal_ponding(days_with_ponding),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE
                                                  ),
              group = "Ponding",
              label = labels_ponding)%>%

  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.5,
              fillColor = ~pal_flooding(days_with_flooding),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE
              ),
              group = "Flooding",
              label = labels_flooding)%>%



  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.5,
              fillColor = ~pal_scarcity(water_scarcity_index),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE),
              group = "Scarcity",
              label=labels_scarcity)%>%

  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.5,
              fillColor = ~pal_scarcity_data(days_no_potable_water),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE),
              group = "Scarcity_data",
              label=labels_scarcity_data)%>%


  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.5,
              fillColor = ~pal_adaptation_AB(potable_water_sensitivity_index),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE),
              group = "Adaptation_W",
              label=labels_adaptation_W)%>%


  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.5,
              fillColor = ~pal_adaptation_D(non_potable_water_sensitivity_index),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE),
              group = "Adaptation_D",
              label=labels_adaptation_D)%>%

  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.5,
              fillColor = ~pal_interventions_D(non_potable_water_system_intervention_count),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE),
              group = "Interventions_D",
              label=labels_gov_interventions_D)%>%

  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.5,
              fillColor = ~pal_potable_water_system_intervention_count(potable_water_system_intervention_count),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE),
              group = "Interventions_W",
              label=labels_gov_potable_water_system_intervention_count)%>%

  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.5,
              fillColor = ~pal_protests(water_scarcity_index),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE),
              group = "Social_Pressure",
              label=labels_protest)%>%

  setView(lng=mean(xl), lat=mean(yl), zoom = 10) %>%

#############legends######################################
  addLegend("bottomright", pal = pal, values = ~non_potable_water_vulnerability_index,
            title = "Vulnerability Drainage",
            labFormat = labelFormat(prefix = ""),
            opacity = 1,group = "Vulnerability_D"
  )%>%
  addLegend("bottomright", pal = pal_infra_Ab, values = ~potable_water_infrastructure_age,
            title = "Infrastructure",
            labFormat = labelFormat(prefix = ""),
            opacity = 1,group = "Infrastructure_W"
  )%>%
  addLegend("bottomright", pal = pal_infra_D, values = ~non_potable_water_infrastructure_age,
            title = "Infrastructure",
            labFormat = labelFormat(prefix = ""),
            opacity = 1,group = "Infrastructure_D"
  )%>%

  addLegend("bottomright", pal = pal_ponding, values = ~days_with_ponding,
            title = "Ponding",
            labFormat = labelFormat(prefix = ""),
            opacity = 1,group = "Ponding"
  )%>%
  addLegend("bottomright", pal = pal_flooding, values = ~days_with_flooding,
            title = "Ponding_data",
            labFormat = labelFormat(prefix = ""),
            opacity = 1,group = "Ponding_data"
  )%>%
  addLegend("bottomright", pal = pal_scarcity, values = ~water_scarcity_index,
            title = " Water Scarcity Index",
            labFormat = labelFormat(prefix = ""),
            opacity = 1,group = "Scarcity"
  )%>%
  addLegend("bottomright", pal = pal_scarcity_data, values = ~days_no_potable_water,
            title = " Water Scarcity [days/weeks]",
            labFormat = labelFormat(prefix = ""),
            opacity = 1,group = "Scarcity_data"
  )%>%
  addLegend("bottomright", pal = pal_adaptation_AB, values = ~potable_water_sensitivity_index,
            title = "# actions residents W",
            labFormat = labelFormat(prefix = ""),
            opacity = 1,group = "Adaptation_W"
  )%>%
  addLegend("bottomright", pal = pal_adaptation_D, values = ~non_potable_water_sensitivity_index,
            title = "# actions residents D",
            labFormat = labelFormat(prefix = ""),
            opacity = 1,group = "Adaptation_D"
  )%>%
  addLegend("bottomright", pal = pal_interventions_D, values = ~non_potable_water_system_intervention_count,
            title = "# actions residents D",
            labFormat = labelFormat(prefix = ""),
            opacity = 1,group = "Interventions_D"
  )%>%
  addLegend("bottomright", pal = pal_potable_water_system_intervention_count, values = ~potable_water_system_intervention_count,
            title = "# actions residents W",
            labFormat = labelFormat(prefix = ""),
            opacity = 1,group = "Interventions_W"
  )%>%

  addLegend("bottomright", pal = pal_protests, values = ~water_scarcity_index,
            title = "# actions residents W",
            labFormat = labelFormat(prefix = ""),
            opacity = 1,group = "Social_Pressure"
  )%>%
#####control############
  addLayersControl(
  baseGroups = c("Mapa Base"),
  overlayGroups = c("Vulnerability_D", "Infrastructure_D","Infrastructure_W","Ponding","Ponding_data","Scarcity","Scarcity_data","Adaptation_W","Adaptation_D","Interventions_D","Interventions_W","Social_Pressure"),
  options = layersControlOptions(collapsed = FALSE)
)%>%
hideGroup(c("Vulnerability_D","Infrastructure_D","Infrastructure_W","Ponding","Ponding_data","Scarcity","Scarcity_data","Adaptation_W","Adaptation_D","Interventions_D","Interventions_W","Social_Pressure"))
print(m)
}
