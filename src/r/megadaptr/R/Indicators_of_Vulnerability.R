#Indicators of Vulnerability
require(leaflet)
map_results=function(megadapt_model, megadapt_output){
browser()
  Initial_outcome=subset(megadapt_output,year_sim==2018)
final_outcome=subset(megadapt_output,year_sim==(2018+megadapt_model$params$n_steps)) #indicate final year for outcome  

Final_Outcome=megadapt_model$study_area



Final_Outcome@data=final_outcome

#####save Final_Outcome result as shape file######
#writeSpatialShape(x = Final_Outcome,fn = paste(path_to_output,'Output_MEGADAPT_Oct2018',sep=""))

#Final_Outcome$encharca<-round(studyArea_CVG@data$f_en)
#show results as map
xl=c(-98.9, -99.3)
yl=c(19, 19.6)

####################Labels for highlights



labels_ponding <- sprintf(
  "<strong>%s</strong><br/>%s ID / %g events",
  Final_Outcome$ageb_id,Final_Outcome$cvgeo,Final_Outcome$encharca
) %>% lapply(htmltools::HTML)

labels_flooding <- sprintf(
  "<strong>%s</strong><br/>%s ID / %g events",
  Final_Outcome$ageb_id,Final_Outcome$cvgeo,Final_Outcome$inunda
) %>% lapply(htmltools::HTML)



labels_scarcity <- sprintf(
  "<strong>%s</strong><br/>%s ID / %g average days/week",
  Final_Outcome$ageb_id,Final_Outcome$cvgeo,Final_Outcome$scarcity_index
) %>% lapply(htmltools::HTML)

labels_scarcity_data <- sprintf(
  "<strong>%s</strong><br/>%s ID / %g average days/week",
  Final_Outcome$ageb_id,Final_Outcome$cvgeo,Final_Outcome$lambdas
) %>% lapply(htmltools::HTML)


labels_gov_interventions_D <- sprintf(
  "<strong>%s</strong><br/>%s ID / %g interventions",
  Final_Outcome$ageb_id,Final_Outcome$cvgeo,round(Final_Outcome$Interventions_D)
) %>% lapply(htmltools::HTML)

labels_gov_interventions_Ab <- sprintf(
  "<strong>%s</strong><br/>%s ID / %g interventions",
  Final_Outcome$ageb_id,Final_Outcome$cvgeo,Final_Outcome$Interventions_Ab
) %>% lapply(htmltools::HTML)

labels_protest <- sprintf(
  "<strong>%s</strong><br/>%s ID / %g Protests",
  Final_Outcome$ageb_id,Final_Outcome$cvgeo,Final_Outcome$scarcity_index
) %>% lapply(htmltools::HTML)

labels_adaptation_D <- sprintf(
  "<strong>%s</strong><br/>%s ID / %g interventions",
  Final_Outcome$ageb_id,Final_Outcome$cvgeo,Final_Outcome$sensitivity_D
) %>% lapply(htmltools::HTML)

labels_adaptation_W <- sprintf(
  "<strong>%s</strong><br/>%s ID / %g interventions",
  Final_Outcome$ageb_id,Final_Outcome$cvgeo,Final_Outcome$sensitivity_Ab
) %>% lapply(htmltools::HTML)

labels_Infra_D <- sprintf(
  "<strong>%s</strong><br/>%s ID / %s Years",
  Final_Outcome$ageb_id,Final_Outcome$cvgeo,Final_Outcome$antiguedad_dren
) %>% lapply(htmltools::HTML)

labels_Infra_W <- sprintf(
  "<strong>%s</strong><br/>%s ID / %s Years",
    Final_Outcome$ageb_id,Final_Outcome$cvgeo,Final_Outcome$antiguedad_dist
) %>% lapply(htmltools::HTML)


########colors pals########################################
##
pal <- colorNumeric(
  palette = "YlOrRd",
  domain = Final_Outcome$vulnerability_D
)

pal_infra_Ab <- colorNumeric(
  palette = "YlOrRd",
  domain = Final_Outcome$antiguedad_dist
)

pal_infra_D <- colorNumeric(
  palette = "YlOrRd",
  domain = Final_Outcome$antiguedad_dren
)

pal_ponding <- colorNumeric(
  palette = "Blues",
  domain = Final_Outcome$encharca
)

pal_flooding <- colorNumeric(
  palette = "Blues",
  domain = Final_Outcome$inunda
)


pal_scarcity <- colorNumeric(
  palette = "Reds",
  domain = Final_Outcome$scarcity_index
)
pal_scarcity_data <- colorNumeric(
  palette = "Reds",
  domain = Final_Outcome$lambdas
)


pal_adaptation_AB <- colorNumeric(
  palette = "Reds",
  domain = Final_Outcome$sensitivity_Ab,
  reverse = F
)

pal_adaptation_D <- colorNumeric(
  palette = "Blues",
  domain = Final_Outcome$sensitivity_D,
  reverse = F
  
)
#pal_adaptation_D<-colorBin(
#  palette = "Blues",
#  domain = Final_Outcome$sensitivity_D)

#qpal <- colorQuantile("Blues", Final_Outcome$encharca)

pal_interventions_D<-colorBin(
  palette = "Blues",
  domain = Final_Outcome$Interventions_D)

pal_interventions_Ab<-colorBin(
  palette = "Reds",
  domain = Final_Outcome$Interventions_Ab)

pal_protests<-colorNumeric(
  palette = "Reds",
  domain = Final_Outcome$scarcity_index)

############################################################
m <- leaflet(data=Final_Outcome) %>%
  addTiles("Indicators of Vulnerability") %>%
    addTiles() %>%  # Add default OpenStreetMap map tiles
  addMarkers(lng=-99.1398, lat=19.4249,popup="Mexico City") %>%
  addPolygons(fillColor = "transparent", stroke = FALSE,group = "Mapa Base") %>%
  
  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.5,
              fillColor = ~pal_infra_D(antiguedad_dren),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE),
              group = "Infrastructure_D",
              label=labels_Infra_D)%>%

  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
             opacity = 1.0, fillOpacity = 0.5,
             fillColor = ~pal_infra_Ab(antiguedad_dist),
            highlightOptions = highlightOptions(color = "white", weight = 2,
                                                bringToFront = TRUE),
             group = "Infrastructure_W",
            label=labels_Infra_W)%>%
  
    
  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
             opacity = 1.0, fillOpacity = 0.5,
              fillColor = ~colorQuantile("YlOrRd", vulnerability_D)(vulnerability_D),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE),group = "Vulnerability_D")%>%
  
  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.5,
              fillColor = ~pal_ponding(encharca),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE
                                                  ),
              group = "Ponding",
              label = labels_ponding)%>%
  
  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.5,
              fillColor = ~pal_flooding(inunda),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE
              ),
              group = "Flooding",
              label = labels_flooding)%>%
  
  
  
  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.5,
              fillColor = ~pal_scarcity(scarcity_index),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE),
              group = "Scarcity",
              label=labels_scarcity)%>%
  
  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.5,
              fillColor = ~pal_scarcity_data(lambdas),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE),
              group = "Scarcity_data",
              label=labels_scarcity_data)%>%
  
  
  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.5,
              fillColor = ~pal_adaptation_AB(sensitivity_Ab),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE),
              group = "Adaptation_W",
              label=labels_adaptation_W)%>%
  
  
  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.5,
              fillColor = ~pal_adaptation_D(sensitivity_D),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE),
              group = "Adaptation_D",
              label=labels_adaptation_D)%>%
  
  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.5,
              fillColor = ~pal_interventions_D(Interventions_D),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE),
              group = "Interventions_D",
              label=labels_gov_interventions_D)%>%
  
  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.5,
              fillColor = ~pal_interventions_Ab(Interventions_Ab),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE),
              group = "Interventions_W",
              label=labels_gov_interventions_Ab)%>%
  
  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.5,
              fillColor = ~pal_protests(scarcity_index),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE),
              group = "Social_Pressure",
              label=labels_protest)%>%
    
  setView(lng=mean(xl), lat=mean(yl), zoom = 10) %>%
  
#############legends######################################
  addLegend("bottomright", pal = pal, values = ~vulnerability_D,
            title = "Vulnerability Drainage",
            labFormat = labelFormat(prefix = ""),
            opacity = 1,group = "Vulnerability_D"
  )%>%
  addLegend("bottomright", pal = pal_infra_Ab, values = ~antiguedad_dist,
            title = "Infrastructure",
            labFormat = labelFormat(prefix = ""),
            opacity = 1,group = "Infrastructure_W"
  )%>%
  addLegend("bottomright", pal = pal_infra_D, values = ~antiguedad_dren,
            title = "Infrastructure",
            labFormat = labelFormat(prefix = ""),
            opacity = 1,group = "Infrastructure_D"
  )%>%
  
  addLegend("bottomright", pal = pal_ponding, values = ~encharca,
            title = "Ponding",
            labFormat = labelFormat(prefix = ""),
            opacity = 1,group = "Ponding"
  )%>%
  addLegend("bottomright", pal = pal_flooding, values = ~inunda,
            title = "Ponding_data",
            labFormat = labelFormat(prefix = ""),
            opacity = 1,group = "Ponding_data"
  )%>%
  addLegend("bottomright", pal = pal_scarcity, values = ~scarcity_index,
            title = " Water Scarcity Index",
            labFormat = labelFormat(prefix = ""),
            opacity = 1,group = "Scarcity"
  )%>%
  addLegend("bottomright", pal = pal_scarcity_data, values = ~lambdas,
            title = " Water Scarcity [days/weeks]",
            labFormat = labelFormat(prefix = ""),
            opacity = 1,group = "Scarcity_data"
  )%>%
  addLegend("bottomright", pal = pal_adaptation_AB, values = ~sensitivity_Ab,
            title = "# actions residents W",
            labFormat = labelFormat(prefix = ""),
            opacity = 1,group = "Adaptation_W"
  )%>%
  addLegend("bottomright", pal = pal_adaptation_D, values = ~sensitivity_D,
            title = "# actions residents D",
            labFormat = labelFormat(prefix = ""),
            opacity = 1,group = "Adaptation_D"
  )%>%
  addLegend("bottomright", pal = pal_interventions_D, values = ~Interventions_D,
            title = "# actions residents D",
            labFormat = labelFormat(prefix = ""),
            opacity = 1,group = "Interventions_D"
  )%>%
  addLegend("bottomright", pal = pal_interventions_Ab, values = ~Interventions_Ab,
            title = "# actions residents W",
            labFormat = labelFormat(prefix = ""),
            opacity = 1,group = "Interventions_W"
  )%>%
  
  addLegend("bottomright", pal = pal_protests, values = ~scarcity_index,
            title = "# actions residents W",
            labFormat = labelFormat(prefix = ""),
            opacity = 1,group = "Social_Pressure"
  )%>%
#####control############
  addLayersControl(
  baseGroups = c("Mapa Base"),
  overlayGroups = c("Vulnerability_D", "Infrastructure_D","Infrastructure_W","Ponding","Ponding_data","Scarcity","Scarcity_data","Adaptation_W","Adaptation_D","Interventions_D","Interventions_W","Social_Pressure"),
  options = layersControlOptions(collapsed = FALSE)
)%>%
hideGroup(c("Vulnerability_D","Infrastructure_D","Infrastructure_W","Ponding","Ponding_data","Scarcity","Scarcity_data","Adaptation_W","Adaptation_D","Interventions_D","Interventions_W","Social_Pressure"))
print(m)
}
